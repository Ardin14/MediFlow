# Database Schema Documentation

## Core Tables

### clinics
Stores information about medical clinics.

```sql
CREATE TABLE public.clinics (
    id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    name text NOT NULL,
    address text NOT NULL,
    phone text,
    email text,
    license_number text,
    tax_id text,
    status text NOT NULL DEFAULT 'pending_verification',
    settings jsonb DEFAULT '{}'::jsonb,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now()
);
```

**Indexes:**
- `clinic_name_idx` on `(name)`
- `clinic_status_idx` on `(status)`

**Settings Schema:**
```json
{
  "working_hours": {
    "monday": { "start": "09:00", "end": "17:00" },
    "tuesday": { "start": "09:00", "end": "17:00" },
    // ... other days
  },
  "appointment_types": [
    {
      "id": "routine",
      "name": "Routine Checkup",
      "duration": 30,
      "color": "#4CAF50"
    }
    // ... other types
  ],
  "notification_preferences": {
    "email": true,
    "sms": true
  }
}
```

### clinic_users
Manages staff members and their roles within clinics.

```sql
CREATE TABLE public.clinic_users (
    id uuid DEFAULT gen_random_uuid() PRIMARY KEY,
    user_id uuid REFERENCES auth.users NOT NULL,
    clinic_id bigint REFERENCES public.clinics NOT NULL,
    role text NOT NULL,
    full_name text NOT NULL,
    email text NOT NULL,
    phone text,
    specialization text,
    license_number text,
    status text NOT NULL DEFAULT 'pending',
    settings jsonb DEFAULT '{}'::jsonb,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now(),
    UNIQUE(user_id, clinic_id)
);
```

**Indexes:**
- `clinic_users_user_id_idx` on `(user_id)`
- `clinic_users_clinic_id_idx` on `(clinic_id)`
- `clinic_users_role_idx` on `(role)`
- `clinic_users_status_idx` on `(status)`

### patients
Stores patient information.

```sql
CREATE TABLE public.patients (
    id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    clinic_id bigint REFERENCES public.clinics NOT NULL,
    user_id uuid REFERENCES auth.users,
    full_name text NOT NULL,
    date_of_birth date,
    gender text,
    phone text,
    email text,
    address text,
    emergency_contact jsonb,
    medical_history jsonb DEFAULT '{}'::jsonb,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now()
);
```

**Indexes:**
- `patient_clinic_id_idx` on `(clinic_id)`
- `patient_user_id_idx` on `(user_id)`
- `patient_name_idx` on `(full_name)`

**Emergency Contact Schema:**
```json
{
  "name": "John Doe",
  "relationship": "Spouse",
  "phone": "+1234567890",
  "address": "123 Main St"
}
```

**Medical History Schema:**
```json
{
  "allergies": [
    {
      "type": "medication",
      "name": "Penicillin",
      "severity": "high",
      "noted_date": "2025-01-01"
    }
  ],
  "conditions": [
    {
      "name": "Hypertension",
      "diagnosed_date": "2024-06-15",
      "status": "active"
    }
  ],
  "medications": [
    {
      "name": "Lisinopril",
      "dosage": "10mg",
      "frequency": "daily",
      "start_date": "2024-06-15"
    }
  ]
}
```

### appointments
Manages patient appointments.

```sql
CREATE TABLE public.appointments (
    id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    clinic_id bigint REFERENCES public.clinics NOT NULL,
    patient_id bigint REFERENCES public.patients NOT NULL,
    doctor_id uuid REFERENCES auth.users NOT NULL,
    scheduled_at timestamp with time zone NOT NULL,
    duration integer NOT NULL, -- in minutes
    type text NOT NULL,
    status text NOT NULL DEFAULT 'scheduled',
    notes text,
    metadata jsonb DEFAULT '{}'::jsonb,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now()
);
```

**Indexes:**
- `appointment_clinic_id_idx` on `(clinic_id)`
- `appointment_patient_id_idx` on `(patient_id)`
- `appointment_doctor_id_idx` on `(doctor_id)`
- `appointment_scheduled_at_idx` on `(scheduled_at)`
- `appointment_status_idx` on `(status)`

### medical_records
Stores patient medical records.

```sql
CREATE TABLE public.medical_records (
    id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    clinic_id bigint REFERENCES public.clinics NOT NULL,
    patient_id bigint REFERENCES public.patients NOT NULL,
    appointment_id bigint REFERENCES public.appointments,
    created_by uuid REFERENCES auth.users NOT NULL,
    type text NOT NULL,
    details jsonb NOT NULL,
    attachments jsonb[] DEFAULT '{}',
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now()
);
```

**Indexes:**
- `medical_records_clinic_id_idx` on `(clinic_id)`
- `medical_records_patient_id_idx` on `(patient_id)`
- `medical_records_type_idx` on `(type)`

**Details Schema (for consultation):**
```json
{
  "symptoms": ["fever", "cough"],
  "diagnosis": "Upper respiratory infection",
  "notes": "Patient presents with...",
  "vital_signs": {
    "temperature": 38.5,
    "blood_pressure": "120/80",
    "heart_rate": 75,
    "respiratory_rate": 16
  },
  "treatment_plan": "Rest and fluids..."
}
```

### prescriptions
Manages patient prescriptions.

```sql
CREATE TABLE public.prescriptions (
    id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    clinic_id bigint REFERENCES public.clinics NOT NULL,
    patient_id bigint REFERENCES public.patients NOT NULL,
    doctor_id uuid REFERENCES auth.users NOT NULL,
    medical_record_id bigint REFERENCES public.medical_records,
    status text NOT NULL DEFAULT 'active',
    details jsonb NOT NULL,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now()
);
```

**Details Schema:**
```json
{
  "medications": [
    {
      "name": "Amoxicillin",
      "dosage": "500mg",
      "frequency": "3 times daily",
      "duration": "7 days",
      "instructions": "Take with food",
      "quantity": 21
    }
  ],
  "notes": "Complete full course",
  "refills": 0
}
```

### billing_records
Tracks patient billing and payments.

```sql
CREATE TABLE public.billing_records (
    id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    clinic_id bigint REFERENCES public.clinics NOT NULL,
    patient_id bigint REFERENCES public.patients NOT NULL,
    appointment_id bigint REFERENCES public.appointments,
    amount decimal(10,2) NOT NULL,
    status text NOT NULL DEFAULT 'pending',
    payment_method text,
    payment_details jsonb,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now()
);
```

## Support Tables

### role_permissions
Defines granular permissions for each role.

```sql
CREATE TABLE public.role_permissions (
    id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    role text NOT NULL,
    resource text NOT NULL,
    action text NOT NULL,
    conditions jsonb DEFAULT '{}'::jsonb,
    created_at timestamp with time zone DEFAULT now(),
    UNIQUE(role, resource, action)
);
```

### audit_logs
Tracks all significant system actions.

```sql
CREATE TABLE public.audit_logs (
    id uuid DEFAULT gen_random_uuid() PRIMARY KEY,
    clinic_id bigint REFERENCES public.clinics,
    user_id uuid REFERENCES auth.users,
    action text NOT NULL,
    entity_type text NOT NULL,
    entity_id text NOT NULL,
    changes jsonb,
    metadata jsonb DEFAULT '{}'::jsonb,
    created_at timestamp with time zone DEFAULT now()
);
```

## Views

### active_appointments
```sql
CREATE VIEW active_appointments AS
SELECT 
    a.*,
    p.full_name as patient_name,
    cu.full_name as doctor_name
FROM appointments a
JOIN patients p ON a.patient_id = p.id
JOIN clinic_users cu ON a.doctor_id = cu.user_id
WHERE a.status IN ('scheduled', 'confirmed')
AND a.scheduled_at >= CURRENT_DATE;
```

### patient_summary
```sql
CREATE VIEW patient_summary AS
SELECT 
    p.*,
    COUNT(DISTINCT a.id) as total_appointments,
    COUNT(DISTINCT mr.id) as total_medical_records,
    COUNT(DISTINCT pr.id) as total_prescriptions
FROM patients p
LEFT JOIN appointments a ON p.id = a.patient_id
LEFT JOIN medical_records mr ON p.id = mr.patient_id
LEFT JOIN prescriptions pr ON p.id = pr.patient_id
GROUP BY p.id;
```

## Functions

### has_permission
Checks if a user has a specific permission.

```sql
CREATE OR REPLACE FUNCTION public.has_permission(
    p_user_id uuid,
    p_resource text,
    p_action text
) RETURNS boolean
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
BEGIN
  RETURN EXISTS (
    SELECT 1
    FROM clinic_users cu
    JOIN role_permissions rp ON cu.role = rp.role
    WHERE cu.user_id = p_user_id
    AND rp.resource = p_resource
    AND rp.action = p_action
    AND cu.status = 'active'
  );
END;
$$;
```

### transfer_patients
Handles bulk patient transfers between clinics.

```sql
CREATE OR REPLACE FUNCTION public.transfer_patients(
    p_patient_ids bigint[],
    p_target_clinic_id bigint
) RETURNS void
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
BEGIN
  -- Update patient records
  UPDATE patients
  SET clinic_id = p_target_clinic_id,
      updated_at = NOW()
  WHERE id = ANY(p_patient_ids);
  
  -- Update appointments
  UPDATE appointments
  SET status = 'cancelled',
      updated_at = NOW()
  WHERE patient_id = ANY(p_patient_ids)
  AND status IN ('scheduled', 'confirmed');
  
  -- Create transfer records
  INSERT INTO patient_transfer_history (
    patient_id,
    from_clinic_id,
    to_clinic_id,
    transferred_by,
    transferred_at
  )
  SELECT
    p.id,
    p.clinic_id,
    p_target_clinic_id,
    auth.uid(),
    NOW()
  FROM patients p
  WHERE p.id = ANY(p_patient_ids);
END;
$$;
```